## Lab: traps

#### 0. ç›®å½•

[TOC]

#### 1. RISC-V assembly (easy)

##### 1.1. å®éªŒç›®çš„

* äº†è§£ä¸€äº› RISC-V ç¨‹åºé›†éå¸¸é‡è¦ï¼Œxv6 å­˜å‚¨åº“ä¸­æœ‰ä¸€ä¸ªæ–‡ä»¶`user/call.c`ï¼Œ`makefs.img`ç¼–è¯‘å®ƒï¼Œå¹¶åœ¨`user/call.asm`ä¸­ç”Ÿæˆç¨‹åºçš„å¯è¯»æ±‡ç¼–ç‰ˆæœ¬

  ```c
  #include "kernel/param.h"
  #include "kernel/types.h"
  #include "kernel/stat.h"
  #include "user/user.h"
  
  int g(int x) {
    return x+3;
  }
  
  int f(int x) {
    return g(x);
  }
  
  void main(void) {
    printf("%d %d\n", f(8)+1, 13);
    exit(0);
  }
  ```

  ```basic
  user/_call:     file format elf64-littleriscv
  
  
  Disassembly of section .text:
  
  0000000000000000 <g>:
  #include "kernel/param.h"
  #include "kernel/types.h"
  #include "kernel/stat.h"
  #include "user/user.h"
  
  int g(int x) {
     0:	1141                	addi	sp,sp,-16
     2:	e422                	sd	s0,8(sp)
     4:	0800                	addi	s0,sp,16
    return x+3;
  }
     6:	250d                	addiw	a0,a0,3
     8:	6422                	ld	s0,8(sp)
     a:	0141                	addi	sp,sp,16
     c:	8082                	ret
  
  000000000000000e <f>:
  
  int f(int x) {
     e:	1141                	addi	sp,sp,-16
    10:	e422                	sd	s0,8(sp)
    12:	0800                	addi	s0,sp,16
    return g(x);
  }
    14:	250d                	addiw	a0,a0,3
    16:	6422                	ld	s0,8(sp)
    18:	0141                	addi	sp,sp,16
    1a:	8082                	ret
  
  000000000000001c <main>:
  
  void main(void) {
    1c:	1141                	addi	sp,sp,-16
    1e:	e406                	sd	ra,8(sp)
    20:	e022                	sd	s0,0(sp)
    22:	0800                	addi	s0,sp,16
    printf("%d %d\n", f(8)+1, 13);
    24:	4635                	li	a2,13
    26:	45b1                	li	a1,12
    28:	00000517          	auipc	a0,0x0
    2c:	7a050513          	addi	a0,a0,1952 # 7c8 <malloc+0xe8>
    30:	00000097          	auipc	ra,0x0
    34:	5f8080e7          	jalr	1528(ra) # 628 <printf>
    exit(0);
    38:	4501                	li	a0,0
    3a:	00000097          	auipc	ra,0x0
    3e:	274080e7          	jalr	628(ra) # 2ae <exit>
  ```

* é˜…è¯»`call.asm`ä¸­å‡½æ•°`g`ã€`f`å’Œ`main`çš„ä»£ç ï¼Œé˜…è¯» RISC-V çš„ä½¿ç”¨è¯´æ˜ä¹¦è§å‚è€ƒé¡µï¼Œå›ç­”ä¸€äº›é—®é¢˜

##### 1.2. å®éªŒæ­¥éª¤

* å“ªäº›å¯„å­˜å™¨åŒ…å«å‡½æ•°çš„å‚æ•°ï¼Ÿä¾‹å¦‚ï¼Œåœ¨`main`å¯¹`printf`çš„è°ƒç”¨ä¸­ï¼Œå“ªä¸ªå¯„å­˜å™¨ä¿å­˜ 13ï¼Ÿ

  ![](./picture/4.1.2.1.png)

  æ ¹æ®å›¾ç‰‡ï¼Œå¯„å­˜å™¨ a0-a7 å­˜æ”¾å‚æ•°

  ```basic
  printf("%d %d\n", f(8)+1, 13);
  24:	4635                	li	a2,13
  ```

  æ ¹æ®è¿™æ®µç¼–è¯‘å‡ºçš„æ±‡ç¼–ä»£ç ï¼Œ13 ä¿å­˜åœ¨å¯„å­˜å™¨ a2 ä¸­

* `main`çš„æ±‡ç¼–ä»£ç ä¸­å¯¹å‡½æ•°`f`çš„è°ƒç”¨åœ¨å“ªé‡Œï¼Ÿ`g`çš„è°ƒç”¨åœ¨å“ªé‡Œï¼Ÿï¼ˆæç¤ºï¼šç¼–è¯‘å™¨å¯ä»¥å†…è”å‡½æ•°ï¼‰

  æºä»£ç ä¸­ï¼Œå‡½æ•°`f`è°ƒç”¨å‡½æ•°`g`ï¼Œ`main`å‡½æ•°è°ƒç”¨å‡½æ•°`f`ï¼Œè§‚å¯Ÿæ±‡ç¼–ä»£ç ä¸­çš„å‡½æ•°`f`å’Œå‡½æ•°`g`ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°æ±‡ç¼–ä»£ç ç›¸åŒï¼Œè¯´æ˜ç¼–è¯‘å™¨æŠŠå®ƒä»¬å½“æˆäº†åˆ†å¼€çš„å‡½æ•°å¤„ç†

  ```basic
  26:	45b1                	li	a1,12
  ```

  æ ¹æ®ä»¥ä¸Šè¿™æ®µ`main`å‡½æ•°çš„ä»£ç ï¼Œå¯¹å‡½æ•°`f`çš„è°ƒç”¨ç›´æ¥ç®—å‡ºäº†ç»“æœï¼Œç¼–è¯‘å™¨å¯¹å‡½æ•°è¿›è¡Œäº†å†…è”å¤„ç†

* å‡½æ•°`printf`ä½äºå“ªä¸ªåœ°å€ï¼Ÿ

  ```basic
  34:	5f8080e7          	jalr	1528(ra) # 628 <printf>
  ...
  0000000000000628 <printf>:
  ```

  æ ¹æ®ä¸Šé¢ä¸¤å¥æ±‡ç¼–ä»£ç ï¼Œå¾—çŸ¥`printf`åœ¨`0x628`åœ°å€å¤„

* `main`å‡½æ•°é‡Œçš„`jalr`åœ¨`printf`ä¹‹åï¼Œå¯„å­˜å™¨`ra`é‡Œçš„å€¼æ˜¯å¤šå°‘

  * `auipc`æŒ‡ä»¤ï¼šå°†å…¶æºå¸¦çš„20ä½ç«‹å³æ•°ä½œä¸º32ä½çš„é«˜ä½ï¼Œä½12ä½ç½®0ï¼Œç„¶åä¸å½“å‰çš„PCå€¼ç›¸åŠ ï¼Œå°†ç»“æœå†™å…¥ç›®æ ‡å¯„å­˜å™¨ä¸­

    æ±‡ç¼–å†™æ³•ï¼š

    ```basic
    auipc rd, imm
    ```

    ![](./picture/4.1.2.2.png)

  * `jalr`æŒ‡ä»¤ï¼šå°†å…¶æºå¸¦çš„12ä½ç«‹å³æ•°ä¸æºå¯„å­˜å™¨1å€¼ç›¸åŠ ï¼Œå¹¶å°†ç»“æœçš„æœ«å°¾æ¸…é›¶ï¼Œä½œä¸ºè·³è½¬çš„åœ°å€ï¼›ä¸`jal`æŒ‡ä»¤ä¸€æ ·ï¼Œå°†å…¶åçš„æŒ‡ä»¤åœ°å€å­˜å…¥ç›®æ ‡å¯„å­˜å™¨ä¸­

    æ±‡ç¼–å†™æ³•ï¼š

    ```basic
    jalr rd, offset(rs1)
    ```

    ![](./picture/4.1.2.3.png)

  æŸ¥çœ‹æ±‡ç¼–ä»£ç ï¼š

  ```basic
  30:	00000097          	auipc	ra,0x0
  34:	5f8080e7          	jalr	1528(ra) # 628 <printf>
  ```

  `00000097H=00...0 0000 1001 0111B`ï¼Œå¯¹æ¯”æŒ‡ä»¤æ ¼å¼ï¼Œå¯è§ imm=0ï¼Œdest=00001ï¼Œopcode=0010111ï¼Œå¯¹æ¯”æ±‡ç¼–æŒ‡ä»¤å¯çŸ¥ï¼Œ`auipc`çš„æ“ä½œç æ˜¯`0010111`ï¼Œ`ra`å¯„å­˜å™¨ä»£ç æ˜¯`00001`ï¼Œç¬¬ä¸€è¡Œä»£ç å°†`0x0`å·¦ç§» 12 ä½ï¼ˆè¿˜æ˜¯`0x0`ï¼‰åŠ åˆ° PCï¼ˆå½“å‰ä¸º`0x30`ï¼‰ä¸Šå¹¶å­˜å…¥`ra`ä¸­ï¼Œå³`ra`ä¸­ä¿å­˜çš„æ˜¯`0x30`

  `5f8080e7H=0101 1111 1000 0000 1000 0000 1110 0111B`ï¼Œå¯è§ imm=0101 1111 1000ï¼Œrs1=00001ï¼Œfunct3=000ï¼Œrd=00001ï¼Œopcode=1100111ï¼Œ`rs1`å’Œ`rd`çš„æ“ä½œç éƒ½æ˜¯`00001`ï¼Œå³éƒ½ä¸ºå¯„å­˜å™¨`ra`ï¼Œè¿™å¯¹æ¯”`jalr`çš„æ ‡å‡†æ ¼å¼æœ‰æ‰€ä¸åŒï¼Œå¯èƒ½æ˜¯æ­¤ä¸¤å¤„ä½¿ç”¨å¯„å­˜å™¨ç›¸åŒæ—¶ï¼Œæ±‡ç¼–ä¸­å¯ä»¥çœç•¥`rd`éƒ¨åˆ†ã€‚`ra`ä¸­ä¿å­˜çš„æ˜¯`0x30`ï¼ŒåŠ ä¸Š`0x5f8`åä¸º`0x628`ï¼Œå³`printf`çš„åœ°å€ï¼Œæ‰§è¡Œæ­¤è¡Œä»£ç åï¼Œå°†è·³è½¬åˆ°`printf`å‡½æ•°æ‰§è¡Œï¼Œå¹¶å°†`PC+4=0x34+0x4=0x38`ä¿å­˜åˆ°`ra`ä¸­ï¼Œä¾›ä¹‹åè¿”å›ä½¿ç”¨

* è¿è¡Œä»£ç åï¼Œè¾“å‡ºæ˜¯ä»€ä¹ˆï¼Ÿå¦‚æœæ˜¯å¤§ç«¯åºè¦æŠŠ i å€¼è®¾ä¸ºå¤šå°‘ï¼Ÿ57616 è¦æ”¹å˜å—ï¼Ÿ

  ä»£ç ï¼š

  ```c
  #include <stdio.h>
  int main()
  {unsigned int i = 0x00646c72;printf("H%x Wo%s",57616,&i);return 0;}
  ```

  ç»“æœæ˜¯ï¼š`He110 World`

  57616 è½¬æ¢æˆ 16 è¿›åˆ¶æ˜¯ 0xe110ï¼Œè§„å®š e å°å†™ï¼›è€Œ 0x646c72 è½¬æ¢æˆ 2 è¿›åˆ¶åæ˜¯ 0110 0100 0110 1100 0111 0010ï¼ŒæŒ‰ç…§å­—èŠ‚å¤§å°å–å¯¹åº”å°ç«¯åº ASCII ç æ˜¯ 114ï¼Œ108ï¼Œ100ï¼Œè½¬æ¢æˆå­—ç¬¦æ˜¯"r","l","d"

  | åœ°å€     | å¤§ç«¯åº   | å°ç«¯åº   |
  | -------- | -------- | -------- |
  | addr     | 00000000 | 01110010 |
  | addr + 1 | 01100100 | 01101100 |
  | addr + 2 | 01101100 | 01100100 |
  | addr + 3 | 01110010 | 00000000 |

  å¦‚æœæ˜¯å¤§ç«¯åºï¼Œåˆ™ i ä¸º 0111 0010 0110 1100 0110 0100 0000 0000Bï¼Œå³ 0x726c6400

  ç”±äºè½¬åŒ–æˆ 16 è¿›åˆ¶åæ•°å€¼ä¸å˜ï¼Œæ‰€ä»¥ 57616 ä¸éœ€è¦æ”¹

* è¿è¡Œä»£ç åï¼Œ`y=`åé¢æ‰“å°äº†ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆä¼šå‘ç”Ÿï¼Ÿ

  è¿è¡Œä»£ç ï¼š

  ```c
  #include<stdio.h>
  int main(){printf("x=%d y=%d",3);return 0;}
  ```

  ç»“æœï¼š`y=1821894360`

  åŸå› ï¼šåŸæœ¬éœ€è¦ä¸¤ä¸ªå‚æ•°ï¼Œå´åªä¼ å…¥äº†ä¸€ä¸ªï¼Œå› æ­¤`y=`åé¢æ‰“å°çš„ç»“æœå–å†³äºä¹‹å‰`a2`ä¸­ä¿å­˜çš„æ•°æ®

##### 1.3. å®éªŒä¸­é‡åˆ°çš„é—®é¢˜å’Œè§£å†³åŠæ³•

* æŒ‡ä»¤ä¸ç†Ÿæ‚‰ï¼Œåˆ†è§£æˆ 0 å’Œ 1 åå¤ç ”ç©¶

##### 1.4. å®éªŒå¿ƒå¾—

* äº†è§£äº†æ±‡ç¼–è¯­è¨€



#### 2. Backtrace (moderate)

##### 2.1. å®éªŒç›®çš„

* å¯¹äºè°ƒè¯•æ¥è¯´ï¼Œæœ‰ä¸€ä¸ªå›æº¯é€šå¸¸å¾ˆæœ‰ç”¨ï¼šåœ¨å‘ç”Ÿé”™è¯¯çš„ç‚¹ä¹‹ä¸Šçš„å †æ ˆä¸Šçš„å‡½æ•°è°ƒç”¨åˆ—è¡¨
* åœ¨`kernel/printf.c`ä¸­å®ç°ä¸€ä¸ª`backtrace()`å‡½æ•°ã€‚åœ¨`sys_sleep`ä¸­æ’å…¥å¯¹æ­¤å‡½æ•°çš„è°ƒç”¨ï¼Œç„¶åè¿è¡Œ`bttest`ï¼Œå®ƒè°ƒç”¨`sys_sleep`
* ç¼–è¯‘å™¨åœ¨æ¯ä¸ªå †æ ˆå¸§ä¸­æ”¾å…¥ä¸€ä¸ªå¸§æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆä¿å­˜è°ƒç”¨æ–¹çš„å¸§æŒ‡é’ˆçš„åœ°å€ã€‚å›æº¯åº”è¯¥ä½¿ç”¨è¿™äº›å¸§æŒ‡é’ˆå‘ä¸Šéå†å †æ ˆï¼Œå¹¶åœ¨æ¯ä¸ªå †æ ˆå¸§ä¸­æ‰“å°ä¿å­˜çš„è¿”å›åœ°å€

##### 2.2. å®éªŒæ­¥éª¤

* å‘`kernel/riscv.h`æ·»åŠ ä»£ç 

  ![](./picture/4.2.2.1.png)

  ```c
  static inline uint64
  r_fp()
  {
    uint64 x;
    asm volatile("mv %0, s0" : "=r" (x) );
    return x;
  }
  ```

* å‘`kernel/defs.h`æ·»åŠ åŸå‹å£°æ˜

  ![](./picture/4.2.2.2.png)

  ```c
  void		backtrace(void);
  ```

* åœ¨`kernel/printf.c`ä¸­æ·»åŠ `backtrace()`å‡½æ•°

  ![](./picture/4.2.2.3.png)

  ```c
  void
  backtrace(void)
  {
    printf("backtrace:\n");
    // Read current frame pointer
    uint64 fp = r_fp();
    while (PGROUNDUP(fp) - PGROUNDDOWN(fp) == PGSIZE)
    {
      // Save returned address at shift -8
      uint64 ret_addr = *(uint64*)(fp - 8);
      printf("%p\n", ret_addr);
      // Save last pointer at shift -16
      fp = *(uint64*)(fp - 16);
    }
  }
  ```

* å‘`kernel/printf.c`ä¸­çš„`panic()`å‡½æ•°ä¸­æ·»åŠ `backtrace()`çš„å‡½æ•°è°ƒç”¨

  ![](./picture/4.2.2.4.png)

  ```c
  backtrace();
  ```

* æµ‹è¯•é€šè¿‡

  ![](./picture/4.2.2.5.png)

##### 2.3. å®éªŒä¸­é‡åˆ°çš„é—®é¢˜å’Œè§£å†³åŠæ³•

* æ²¡å®Œå…¨ææ‡‚`backtrace()`çš„ä½œç”¨ï¼Œåå¤ç ”ç©¶

##### 2.4. å®éªŒå¿ƒå¾—

* ææ‡‚äº†`backtrace()`çš„ä½œç”¨



#### 3. Alarm (hard)

##### 3.1. å®éªŒç›®çš„

* å‘ xv6 æ·»åŠ ä¸€ä¸ªåŠŸèƒ½ï¼Œè¯¥åŠŸèƒ½åœ¨è¿›ç¨‹ä½¿ç”¨ CPU æ—¶é—´æ—¶å®šæœŸæé†’è¿›ç¨‹ã€‚è¿™å¯¹äºæƒ³è¦é™åˆ¶å ç”¨ CPU æ—¶é—´çš„è®¡ç®—ç»‘å®šè¿›ç¨‹ï¼Œæˆ–è€…å¯¹äºæƒ³è¦è®¡ç®—ä½†ä¹Ÿæƒ³è¦é‡‡å–ä¸€äº›å‘¨æœŸæ€§æ“ä½œçš„è¿›ç¨‹æ¥è¯´å¯èƒ½å¾ˆæœ‰ç”¨ã€‚æ›´ä¸€èˆ¬åœ°è¯´ï¼Œå®ç°ç”¨æˆ·çº§ä¸­æ–­/æ•…éšœå¤„ç†ç¨‹åºçš„åŸå§‹å½¢å¼ï¼›ä¾‹å¦‚ï¼Œä½¿ç”¨ç±»ä¼¼çš„æ–¹æ³•æ¥å¤„ç†åº”ç”¨ç¨‹åºä¸­çš„é¡µé¢é”™è¯¯ã€‚å¦‚æœè§£å†³æ–¹æ¡ˆé€šè¿‡äº†è­¦æŠ¥æµ‹è¯•å’Œç”¨æˆ·æµ‹è¯•ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯æ­£ç¡®çš„
* æ·»åŠ ä¸€ä¸ªæ–°çš„`sigalarm(interval, handler)`ç³»ç»Ÿè°ƒç”¨ã€‚å¦‚æœåº”ç”¨ç¨‹åºè°ƒç”¨`sigalarm(n, fn)`ï¼Œé‚£ä¹ˆåœ¨ç¨‹åºæ¶ˆè€—çš„ CPU æ—¶é—´çš„æ¯ n ä¸ªâ€œæ»´ç­”â€ä¹‹åï¼Œå†…æ ¸åº”è¯¥è°ƒç”¨åº”ç”¨ç¨‹åºå‡½æ•°`fn`ã€‚å½“`fn`è¿”å›æ—¶ï¼Œåº”ç”¨ç¨‹åºåº”è¯¥ä»åœæ­¢çš„åœ°æ–¹æ¢å¤ã€‚åœ¨ xv6 ä¸­ï¼Œtick æ˜¯ä¸€ä¸ªç›¸å½“ä»»æ„çš„æ—¶é—´å•ä½ï¼Œç”±ç¡¬ä»¶è®¡æ—¶å™¨ç”Ÿæˆä¸­æ–­çš„é¢‘ç‡å†³å®šã€‚å¦‚æœåº”ç”¨ç¨‹åºè°ƒç”¨`sigalarm(0, 0)`ï¼Œå†…æ ¸åº”è¯¥åœæ­¢ç”Ÿæˆå‘¨æœŸæ€§çš„è­¦æŠ¥è°ƒç”¨
* åœ¨ xv6 å­˜å‚¨åº“ä¸­æ‰¾åˆ°ä¸€ä¸ªæ–‡ä»¶`user/armtest.c`ã€‚å°†å…¶æ·»åŠ åˆ°`Makefile`ä¸­ã€‚åœ¨æ·»åŠ äº†`sigalarm`å’Œ`sigreturn`ç³»ç»Ÿè°ƒç”¨ä¹‹å‰ï¼Œå®ƒä¸ä¼šæ­£ç¡®ç¼–è¯‘
* `alarmtest`åœ¨`test0`ä¸­è°ƒç”¨`sigalarm(2, periodic)`ï¼Œè¦æ±‚å†…æ ¸æ¯éš” 2 æ¬¡å¼ºåˆ¶è°ƒç”¨`periodic()`ï¼Œç„¶åæ—‹è½¬ä¸€æ®µæ—¶é—´ã€‚å¯ä»¥åœ¨`user/armtest.asm`ä¸­çœ‹åˆ°`alarmtest`çš„æ±‡ç¼–ä»£ç ï¼Œè¿™å¯èƒ½å¯¹è°ƒè¯•å¾ˆæ–¹ä¾¿ã€‚å½“`alarmtest`ç”Ÿæˆç›¸åº”çš„è¾“å‡ºå¹¶ä¸”ç”¨æˆ·æµ‹è¯•ä¹Ÿæ­£ç¡®è¿è¡Œæ—¶ï¼Œè§£å†³æ–¹æ¡ˆæ˜¯æ­£ç¡®çš„

##### 3.2. å®éªŒæ­¥éª¤

* åœ¨`Makefile`ä¸­æ·»åŠ 

  ![](./picture/4.3.2.1.png)

  ```makefile
  $U/_alarmtest\
  ```

* åœ¨`usys.pl`ä¸­æ·»åŠ 

  ![](./picture/4.3.2.2.png)

  ```perl
  entry("sigalarm");
  entry("sigreturn");
  ```

* åœ¨`syscall.h`ä¸­æ·»åŠ 

  ![](./picture/4.3.2.3.png)

  ```c
  #define SYS_sigalarm 22
  #define SYS_sigreturn 23
  ```

* åœ¨`syscall.c`ä¸­æ·»åŠ 

  ![](./picture/4.3.2.4.png)

  ![](./picture/4.3.2.5.png)

  ```c
  extern uint64 sys_sigalarm(void);
  extern uint64 sys_sigreturn(void);
  ...
  [SYS_sigalarm] sys_sigalarm,
  [SYS_sigreturn] sys_sigreturn,
  ```

* åœ¨`proc.h`ä¸­æ·»åŠ 

  ![](./picture/4.3.2.6.png)

  ```c
  uint64 interval;
  void (*handler)();
  uint64 ticks;
  struct trapframe *alarm_trapframe;
  int alarm_goingoff;
  ```

* ç¼–è¾‘`proc.c`ä¸­çš„`allocproc()`å‡½æ•°

  ![](./picture/4.3.2.7.png)

  ```c
  if ((p->alarm_trapframe = (struct trapframe*)kalloc()) == 0)
    {
      freeproc(p);
      release(&p->lock);
      return 0;
    }
  ```

  ![](./picture/4.3.2.8.png)

  ```c
  p->ticks = 0;
  p->handler = 0;
  p->interval = 0;
  p->alarm_goingoff = 0;
  ```

* ç¼–è¾‘`proc.c`ä¸­çš„`freeproc()`å‡½æ•°

  ![](./picture/4.3.2.9.png)

  ```c
  if (p->alarm_trapframe) kfree((void*)p->alarm_trapframe);
  ...
  p->ticks = 0;
  p->handler = 0;
  p->interval = 0;
  p->alarm_goingoff = 0;
  p->state = UNUSED;
  ```

* åœ¨`kernel/sysproc.c`ä¸­å®ç°`sys_sigalarm()`å’Œ`sig_sigreturn()`å‡½æ•°ï¼Œç”¨äºå®ç°ç³»ç»Ÿè°ƒç”¨

  ![](./picture/4.3.2.10.png)

  ```c
  uint64
  sys_sigalarm(void)
  {
    int n;
    uint64 handler;
    if (argint(0, &n) < 0) return -1;
    if (argaddr(1, &handler) < 0) return -1;
    return sigalarm(n, (void(*)())(handler));
  }
  
  uint64
  sys_sigreturn(void){return sigreturn();}
  ```

* åœ¨`trap.c`ä¸­å®ç°`int sigalarm(int ticks, void(*handler)()`ä»¥åŠ`int sigreturn()`

  ![](./picture/4.3.2.11.png)

  ```c
  int
  sigalarm(int ticks, void(*handler)())
  {
    struct proc* p = myproc();
    p->interval = ticks;
    p->handler = handler;
    p->ticks = 0;
    return 0;
  }
  
  int
  sigreturn()
  {
    struct proc* p = myproc();
    *(p->trapframe) = *(p->alarm_trapframe);
    p->alarm_goingoff = 0;
    return 0;
  }
  ```

* åœ¨`trap.c`çš„`usertrap`å‡½æ•°ä¸­æ·»åŠ å®šæ—¶å™¨ä¸­æ–­å“åº”

  ![](./picture/4.3.2.12.png)

  ```c
  else if((which_dev = devintr()) != 0){
      // ok
      if (which_dev == 2)
      {
        if (p->interval != 0)
        {
  	if (p->ticks == p->interval && p->alarm_goingoff == 0)
  	{
  	  p->ticks = 0;
  	  *(p->alarm_trapframe) = *(p->trapframe);
  	  p->trapframe->epc = (uint64)p->handler;
  	  p->alarm_goingoff = 1;
  	}
  	p->ticks++;
        }
      }
    }
  ```

* ä¿®ç† bug ğŸ˜¡

  ![](./picture/4.3.2.13.png)

* ç»“æœæ­£ç¡®ğŸ¤©ğŸ¤©ğŸ¤©

  ![](./picture/4.3.2.14.png)

  ![](./picture/4.3.2.15.png)

##### 3.3. å®éªŒä¸­é‡åˆ°çš„é—®é¢˜å’Œè§£å†³åŠæ³•

* å¯¹æ—¶é’Ÿçš„ç†è§£ä¸æ·±åˆ»ï¼Œåå¤ç ”ç©¶

##### 3.4. å®éªŒå¿ƒå¾—

* ç†è§£äº†æ—¶é’Ÿ



#### Submit

ç¬¬ä¸€é¢˜è§£ç­”åœ¨ä¸Šé¢ï¼Œæ—¶é—´æ–‡ä»¶æ²¡æœ‰

![](./picture/4.3.2.16.png)